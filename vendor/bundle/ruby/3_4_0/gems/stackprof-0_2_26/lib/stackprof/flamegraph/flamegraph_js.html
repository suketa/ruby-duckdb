<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>flamegraph.js - RDoc Documentation</title>

  <meta name="keywords" content="ruby,documentation,flamegraph.js">
  <meta name="description" content="flamegraph.js: Element. Element.">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../../../../../";
  var index_rel_prefix = "../../../../../../../../../";
</script>

<script src="../../../../../../../../../js/navigation.js" defer></script>
<script src="../../../../../../../../../js/search.js" defer></script>
<script src="../../../../../../../../../js/search_index.js" defer></script>
<script src="../../../../../../../../../js/searcher.js" defer></script>
<script src="../../../../../../../../../js/darkfish.js" defer></script>

<link href="../../../../../../../../../css/fonts.css" rel="stylesheet">
<link href="../../../../../../../../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../../../../../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../../../../../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../../../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../../../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
  
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><a href="../../../../../../../../../CHANGELOG_md.html">CHANGELOG</a>
    <li><a href="../../../../../../../../../CONTRIBUTION_md.html">CONTRIBUTION</a>
    <li><a href="../../../../../../../../../Dockerfile.html">Dockerfile</a>
    <li><a href="../../../../../../../../../Gemfile.html">Gemfile</a>
    <li><a href="../../../../../../../../../Gemfile_lock.html">Gemfile.lock</a>
    <li><a href="../../../../../../../../../LICENSE.html">LICENSE</a>
    <li><a href="../../../../../../../../../README_md.html">README</a>
    <li><a href="../../../../../../../../../Rakefile.html">Rakefile</a>
    <li><a href="../../../../../../../../../bin/setup.html">setup</a>
    <li><a href="../../../../../../../../../getduckdb_sh.html">getduckdb.sh</a>
    <li><details open><summary>vendor</summary>
    <ul class="link-list">
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/bin/stackprof-flamegraph_pl.html">stackprof-flamegraph.pl</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/bin/stackprof-gprof2dot_py.html">stackprof-gprof2dot.py</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/mkmf_log.html">mkmf.log</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/racc-1_8_1/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/racc-1_8_1/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/mkmf_log.html">mkmf.log</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/History_md.html">History</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/README_md.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/bigdecimal-3_1_8/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/bigdecimal-3_1_8/ext/bigdecimal/Makefile.html">Makefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/History_rdoc.html">History</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/Manifest_txt.html">Manifest</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/README_rdoc.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/LICENSE-DEPENDENCIES_md.html">LICENSE-DEPENDENCIES</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/LICENSE_md.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/README_md.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/ext/nokogiri/depend.html">depend</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/CHANGES_md.html">CHANGES</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/Makefile.html">Makefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/THANKS.html">THANKS</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/lib/nokogiri/css/tokenizer_rex.html">tokenizer.rex</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/BSDL.html">BSDL</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/COPYING.html">COPYING</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/ChangeLog.html">ChangeLog</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/README_ja_rdoc.html">README.ja</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/README_rdoc.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/TODO.html">TODO</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/en/grammar_en_rdoc.html">grammar.en</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/en/grammar2_en_rdoc.html">grammar2.en</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/command_ja_html.html">command.ja.html</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/debug_ja_rdoc.html">debug.ja</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/grammar_ja_rdoc.html">grammar.ja</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/index_ja_html.html">index.ja.html</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/parser_ja_rdoc.html">parser.ja</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/usage_ja_html.html">usage.ja.html</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/ext/racc/cparse/Makefile.html">Makefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/History_rdoc.html">History</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/MIT-LICENSE.html">MIT-LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/README_rdoc.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/command_line_usage_rdoc.html">command_line_usage</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/example/Rakefile1.html">Rakefile1</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/example/Rakefile2.html">Rakefile2</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/glossary_rdoc.html">glossary</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/proto_rake_rdoc.html">proto_rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rake_1.html">rake.1</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rakefile_rdoc.html">rakefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rational_rdoc.html">rational</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/History_md.html">History</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/LICENSE_txt.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/README_md.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/compile_feature.html">compile.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-compile_feature.html">cross-compile.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-package-multi_feature.html">cross-package-multi.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-package_feature.html">cross-package.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-compile_feature.html">java-compile.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-no-native-compile_feature.html">java-no-native-compile.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-package_feature.html">java-package.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/package_feature.html">package.feature</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/bin/cross-ruby_rake.html">cross-ruby.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/bootstrap_rake.html">bootstrap.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/common_rake.html">common.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/cucumber_rake.html">cucumber.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/gem_rake.html">gem.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/rspec_rake.html">rspec.rake</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Gemfile_lock.html">Gemfile.lock</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/LICENSE_txt.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/README_md.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/suppressions/ruby_supp.html">ruby.supp</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/CHANGELOG_md.html">CHANGELOG</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/README_md.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/bin/stackprof-flamegraph_pl.html">stackprof-flamegraph.pl</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/bin/stackprof-gprof2dot_py.html">stackprof-gprof2dot.py</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/ext/stackprof/Makefile.html">Makefile</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/lib/stackprof/flamegraph/flamegraph_js.html">flamegraph.js</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/lib/stackprof/flamegraph/viewer_html.html">viewer.html</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/FlameGraph/README.html">README</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/FlameGraph/flamegraph_pl.html">flamegraph.pl</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/gprof2dot/gprof2dot_py.html">gprof2dot.py</a>
      <li><a href="../../../../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/gprof2dot/hotshotmain_py.html">hotshotmain.py</a>
    </ul></details>
  </ul>
</div>


  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.10.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

</nav>

<main role="main" aria-label="Page vendor/bundle/ruby/3.4.0/gems/stackprof-0.2.26/lib/stackprof/flamegraph/flamegraph.js">

<p>if (typeof Element.prototype.matches !== ‘function’) {</p>

<pre>Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.mozMatchesSelector || Element.prototype.webkitMatchesSelector || function matches(selector) {
  var element = this
  var elements = (element.document || element.ownerDocument).querySelectorAll(selector)
  var index = 0

  while (elements[index] &amp;&amp; elements[index] !== element) {
    ++index
  }

  return Boolean(elements[index])
}</pre>

<p>}</p>

<p>if (typeof Element.prototype.closest !== ‘function’) {</p>

<pre>Element.prototype.closest = function closest(selector) {
  var element = this

  while (element &amp;&amp; element.nodeType === 1) {
    if (element.matches(selector)) {
      return element
    }

    element = element.parentNode
  }

  return null
}</pre>

<p>}</p>

<p>if (typeof Object.assign !== ‘function’) {</p>

<pre>(function() {
  Object.assign = function(target) {
    &#39;use strict&#39;
    // We must check against these specific cases.
    if (target === undefined || target === null) {
      throw new TypeError(&#39;Cannot convert undefined or null to object&#39;)
    }

    var output = Object(target)
    for (var index = 1; index &lt; arguments.length; index++) {
      var source = arguments[index]
      if (source !== undefined &amp;&amp; source !== null) {
        for (var nextKey in source) {
          if (source.hasOwnProperty(nextKey)) {
            output[nextKey] = source[nextKey]
          }
        }
      }
    }
    return output
  }
})()</pre>

<p>}</p>

<p>function EventSource() {</p>

<pre>var self = this

self.eventListeners = {}</pre>

<p>}</p>

<p>EventSource.prototype.on = function(name, callback) {</p>

<pre>var self = this

var listeners = self.eventListeners[name]
if (!listeners)
  listeners = self.eventListeners[name] = []
listeners.push(callback)</pre>

<p>}</p>

<p>EventSource.prototype.dispatch = function(name, data) {</p>

<pre>var self = this

var listeners = self.eventListeners[name] || []
listeners.forEach(function(c) {
  requestAnimationFrame(function() { c(data) })
})</pre>

<p>}</p>

<p>function CanvasView(canvas) {</p>

<pre>var self = this

self.canvas = canvas</pre>

<p>}</p>

<p>CanvasView.prototype.setDimensions = function(width, height) {</p>

<pre>var self = this

if (self.resizeRequestID)
  cancelAnimationFrame(self.resizeRequestID)

self.resizeRequestID = requestAnimationFrame(self.setDimensionsNow.bind(self, width, height))</pre>

<p>}</p>

<p>CanvasView.prototype.setDimensionsNow = function(width, height) {</p>

<pre>var self = this

if (width === self.width &amp;&amp; height === self.height)
  return

self.width = width
self.height = height

self.canvas.style.width = width
self.canvas.style.height = height

var ratio = window.devicePixelRatio || 1
self.canvas.width = width * ratio
self.canvas.height = height * ratio

var ctx = self.canvas.getContext(&#39;2d&#39;)
ctx.setTransform(1, 0, 0, 1, 0, 0)
ctx.scale(ratio, ratio)

self.repaintNow()</pre>

<p>}</p>

<p>CanvasView.prototype.paint = function() { }</p>

<p>CanvasView.prototype.scheduleRepaint = function() {</p>

<pre>var self = this

if (self.repaintRequestID)
  return

self.repaintRequestID = requestAnimationFrame(function() {
  self.repaintRequestID = null
  self.repaintNow()
})</pre>

<p>}</p>

<p>CanvasView.prototype.repaintNow = function() {</p>

<pre>var self = this

self.canvas.getContext(&#39;2d&#39;).clearRect(0, 0, self.width, self.height)
self.paint()

if (self.repaintRequestID) {
  cancelAnimationFrame(self.repaintRequestID)
  self.repaintRequestID = null
}</pre>

<p>}</p>

<p>function Flamechart(canvas, data, dataRange, info) {</p>

<pre>var self = this

CanvasView.call(self, canvas)
EventSource.call(self)

self.canvas = canvas
self.data = data
self.dataRange = dataRange
self.info = info

self.viewport = {
  x: dataRange.minX,
  y: dataRange.minY,
  width: dataRange.maxX - dataRange.minX,
  height: dataRange.maxY - dataRange.minY,
}</pre>

<p>}</p>

<p>Flamechart.prototype = Object.create(CanvasView.prototype) Flamechart.prototype.constructor = Flamechart Object.assign(Flamechart.prototype, EventSource.prototype)</p>

<p>Flamechart.prototype.xScale = function(x) {</p>

<pre>var self = this
return self.widthScale(x - self.viewport.x)</pre>

<p>}</p>

<p>Flamechart.prototype.yScale = function(y) {</p>

<pre>var self = this
return self.heightScale(y - self.viewport.y)</pre>

<p>}</p>

<p>Flamechart.prototype.widthScale = function(width) {</p>

<pre>var self = this
return width * self.width / self.viewport.width</pre>

<p>}</p>

<p>Flamechart.prototype.heightScale = function(height) {</p>

<pre>var self = this
return height * self.height / self.viewport.height</pre>

<p>}</p>

<p>Flamechart.prototype.frameRect = function(f) {</p>

<pre class="ruby"><span class="ruby-keyword">return</span> {
  <span class="ruby-value">x:</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">x</span>,
  <span class="ruby-value">y:</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">y</span>,
  <span class="ruby-value">width:</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">width</span>,
  <span class="ruby-value">height:</span> <span class="ruby-value">1</span>,
}
</pre>

<p>}</p>

<p>Flamechart.prototype.dataToCanvas = function® {</p>

<pre>var self = this

return {
  x: self.xScale(r.x),
  y: self.yScale(r.y),
  width: self.widthScale(r.width),
  height: self.heightScale(r.height),
}</pre>

<p>}</p>

<p>Flamechart.prototype.setViewport = function(viewport) {</p>

<pre>var self = this

if (self.viewport.x === viewport.x &amp;&amp;
    self.viewport.y === viewport.y &amp;&amp;
    self.viewport.width === viewport.width &amp;&amp;
    self.viewport.height === viewport.height)
  return

self.viewport = viewport

self.scheduleRepaint()

self.dispatch(&#39;viewportchanged&#39;, { current: viewport })</pre>

<p>}</p>

<p>Flamechart.prototype.paint = function(opacity, frames, gemName) {</p>

<pre>var self = this

var ctx = self.canvas.getContext(&#39;2d&#39;)

ctx.strokeStyle = &#39;rgba(0, 0, 0, 0.2)&#39;

if (self.showLabels) {
  ctx.textBaseline = &#39;middle&#39;
  ctx.font = &#39;11px &#39; + getComputedStyle(this.canvas).fontFamily
  // W tends to be one of the widest characters (and if the font is truly
  // fixed-width then any character will do).
  var characterWidth = ctx.measureText(&#39;WWWW&#39;).width / 4
}

if (typeof opacity === &#39;undefined&#39;)
  opacity = 1

frames = frames || self.data

var blocksByColor = {}

frames.forEach(function(f) {
  if (gemName &amp;&amp; f.gemName !== gemName)
    return

  var r = self.dataToCanvas(self.frameRect(f))

  if (r.x &gt;= self.width ||
      r.y &gt;= self.height ||
      (r.x + r.width) &lt;= 0 ||
      (r.y + r.height) &lt;= 0) {
    return
  }

  var i = self.info[f.frame_id]
  var color = colorString(i.color, opacity)
  var colorBlocks = blocksByColor[color]
  if (!colorBlocks)
    colorBlocks = blocksByColor[color] = []
  colorBlocks.push({ rect: r, text: f.frame })
})

var textBlocks = []

Object.keys(blocksByColor).forEach(function(color) {
  ctx.fillStyle = color

  blocksByColor[color].forEach(function(block) {
    if (opacity &lt; 1)
      ctx.clearRect(block.rect.x, block.rect.y, block.rect.width, block.rect.height)

    ctx.fillRect(block.rect.x, block.rect.y, block.rect.width, block.rect.height)

    if (block.rect.width &gt; 4 &amp;&amp; block.rect.height &gt; 4)
      ctx.strokeRect(block.rect.x, block.rect.y, block.rect.width, block.rect.height)

    if (!self.showLabels || block.rect.width / characterWidth &lt; 4)
      return

    textBlocks.push(block)
  })
})

ctx.fillStyle = &#39;#000&#39;
textBlocks.forEach(function(block) {
  var text = block.text
  var textRect = Object.assign({}, block.rect)
  textRect.x += 1
  textRect.width -= 2
  if (textRect.width &lt; text.length * characterWidth * 0.75)
    text = centerTruncate(block.text, Math.floor(textRect.width / characterWidth))
  ctx.fillText(text, textRect.x, textRect.y + textRect.height / 2, textRect.width)
})</pre>

<p>}</p>

<p>Flamechart.prototype.frameAtPoint = function(x, y) {</p>

<pre>var self = this

return self.data.find(function(d) {
  var r = self.dataToCanvas(self.frameRect(d))

  return r.x &lt;= x
    &amp;&amp; r.x + r.width &gt;= x
    &amp;&amp; r.y &lt;= y
    &amp;&amp; r.y + r.height &gt;= y
})</pre>

<p>}</p>

<p>function MainFlamechart(canvas, data, dataRange, info) {</p>

<pre>var self = this

Flamechart.call(self, canvas, data, dataRange, info)

self.showLabels = true

self.canvas.addEventListener(&#39;mousedown&#39;, self.onMouseDown.bind(self))
self.canvas.addEventListener(&#39;mousemove&#39;, self.onMouseMove.bind(self))
self.canvas.addEventListener(&#39;mouseout&#39;, self.onMouseOut.bind(self))
self.canvas.addEventListener(&#39;wheel&#39;, self.onWheel.bind(self))</pre>

<p>}</p>

<p>MainFlamechart.prototype = Object.create(Flamechart.prototype)</p>

<p>MainFlamechart.prototype.setDimensionsNow = function(width, height) {</p>

<pre>var self = this

var viewport = Object.assign({}, self.viewport)
viewport.height = height / 16
self.setViewport(viewport)

CanvasView.prototype.setDimensionsNow.call(self, width, height)</pre>

<p>}</p>

<p>MainFlamechart.prototype.onMouseDown = function(e) {</p>

<pre>var self = this

if (e.button !== 0)
  return

captureMouse({
  mouseup: self.onMouseUp.bind(self),
  mousemove: self.onMouseMove.bind(self),
})

var clientRect = self.canvas.getBoundingClientRect()
var currentX = e.clientX - clientRect.left
var currentY = e.clientY - clientRect.top

self.dragging = true
self.dragInfo = {
  mouse: { x: currentX, y: currentY },
  viewport: { x: self.viewport.x, y: self.viewport.y },
}

e.preventDefault()</pre>

<p>}</p>

<p>MainFlamechart.prototype.onMouseUp = function(e) {</p>

<pre>var self = this

if (!self.dragging)
  return

releaseCapture()

self.dragging = false
e.preventDefault()</pre>

<p>}</p>

<p>MainFlamechart.prototype.onMouseMove = function(e) {</p>

<pre>var self = this

var clientRect = self.canvas.getBoundingClientRect()
var currentX = e.clientX - clientRect.left
var currentY = e.clientY - clientRect.top

if (self.dragging) {
  var viewport = Object.assign({}, self.viewport)
  viewport.x = self.dragInfo.viewport.x - (currentX - self.dragInfo.mouse.x) * viewport.width / self.width
  viewport.y = self.dragInfo.viewport.y - (currentY - self.dragInfo.mouse.y) * viewport.height / self.height
  viewport.x = Math.min(self.dataRange.maxX - viewport.width, Math.max(self.dataRange.minX, viewport.x))
  viewport.y = Math.min(self.dataRange.maxY - viewport.height, Math.max(self.dataRange.minY, viewport.y))
  self.setViewport(viewport)
  return
}

var frame = self.frameAtPoint(currentX, currentY)
self.setHoveredFrame(frame)</pre>

<p>}</p>

<p>MainFlamechart.prototype.onMouseOut = function() {</p>

<pre>var self = this

if (self.dragging)
  return

self.setHoveredFrame(null)</pre>

<p>}</p>

<p>MainFlamechart.prototype.onWheel = function(e) {</p>

<pre>var self = this

var deltaX = e.deltaX
var deltaY = e.deltaY

if (e.deltaMode == WheelEvent.prototype.DOM_DELTA_LINE) {
  deltaX *= 11
  deltaY *= 11
}

if (e.shiftKey) {
  if (&#39;webkitDirectionInvertedFromDevice&#39; in e) {
    if (e.webkitDirectionInvertedFromDevice)
      deltaY *= -1
  } else if (/Mac OS X/.test(navigator.userAgent)) {
    // Assume that most Mac users have &quot;Scroll direction: Natural&quot; enabled.
    deltaY *= -1
  }

  var mouseWheelZoomSpeed = 1 / 120
  self.handleZoomGesture(Math.pow(1.2, -(deltaY || deltaX) * mouseWheelZoomSpeed), e.offsetX)
  e.preventDefault()
  return
}

var viewport = Object.assign({}, self.viewport)
viewport.x += deltaX * viewport.width / (self.dataRange.maxX - self.dataRange.minX)
viewport.x = Math.min(self.dataRange.maxX - viewport.width, Math.max(self.dataRange.minX, viewport.x))
viewport.y += (deltaY / 8) * viewport.height / (self.dataRange.maxY - self.dataRange.minY)
viewport.y = Math.min(self.dataRange.maxY - viewport.height, Math.max(self.dataRange.minY, viewport.y))
self.setViewport(viewport)
e.preventDefault()</pre>

<p>}</p>

<p>MainFlamechart.prototype.handleZoomGesture = function(zoom, originX) {</p>

<pre>var self = this

var viewport = Object.assign({}, self.viewport)
var ratioX = originX / self.width

var newWidth = Math.min(viewport.width / zoom, self.dataRange.maxX - self.dataRange.minX)
viewport.x = Math.max(self.dataRange.minX, viewport.x + (viewport.width - newWidth) * ratioX)
viewport.width = Math.min(newWidth, self.dataRange.maxX - viewport.x)

self.setViewport(viewport)</pre>

<p>}</p>

<p>MainFlamechart.prototype.setHoveredFrame = function(frame) {</p>

<pre>var self = this

if (frame === self.hoveredFrame)
  return

var previous = self.hoveredFrame
self.hoveredFrame = frame

self.dispatch(&#39;hoveredframechanged&#39;, { previous: previous, current: self.hoveredFrame })</pre>

<p>}</p>

<p>function OverviewFlamechart(container, viewportOverlay, data, dataRange, info) {</p>

<pre>var self = this

Flamechart.call(self, container.querySelector(&#39;.overview&#39;), data, dataRange, info)

self.container = container

self.showLabels = false

self.viewportOverlay = viewportOverlay

self.canvas.addEventListener(&#39;mousedown&#39;, self.onMouseDown.bind(self))
self.viewportOverlay.addEventListener(&#39;mousedown&#39;, self.onOverlayMouseDown.bind(self))</pre>

<p>}</p>

<p>OverviewFlamechart.prototype = Object.create(Flamechart.prototype)</p>

<p>OverviewFlamechart.prototype.setViewportOverlayRect = function® {</p>

<pre>var self = this

self.viewportOverlayRect = r

r = self.dataToCanvas(r)
r.width = Math.max(2, r.width)
r.height = Math.max(2, r.height)

if (&#39;transform&#39; in self.viewportOverlay.style) {
  self.viewportOverlay.style.transform = &#39;translate(&#39; + r.x + &#39;px, &#39; + r.y + &#39;px) scale(&#39; + r.width + &#39;, &#39; + r.height + &#39;)&#39;
} else {
  self.viewportOverlay.style.left = r.x
  self.viewportOverlay.style.top = r.y
  self.viewportOverlay.style.width = r.width
  self.viewportOverlay.style.height = r.height
}</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onMouseDown = function(e) {</p>

<pre>var self = this

captureMouse({
  mouseup: self.onMouseUp.bind(self),
  mousemove: self.onMouseMove.bind(self),
})

self.dragging = true
self.dragStartX = e.clientX - self.canvas.getBoundingClientRect().left

self.handleDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onMouseUp = function(e) {</p>

<pre>var self = this

if (!self.dragging)
  return

releaseCapture()

self.dragging = false

self.handleDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onMouseMove = function(e) {</p>

<pre>var self = this

if (!self.dragging)
  return

self.handleDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.handleDragGesture = function(e) {</p>

<pre>var self = this

var clientRect = self.canvas.getBoundingClientRect()
var currentX = e.clientX - clientRect.left
var currentY = e.clientY - clientRect.top

if (self.dragCurrentX === currentX)
  return

self.dragCurrentX = currentX

var minX = Math.min(self.dragStartX, self.dragCurrentX)
var maxX = Math.max(self.dragStartX, self.dragCurrentX)

var rect = Object.assign({}, self.viewportOverlayRect)
rect.x = minX / self.width * self.viewport.width + self.viewport.x
rect.width = Math.max(self.viewport.width / 1000, (maxX - minX) / self.width * self.viewport.width)

rect.y = Math.max(self.viewport.y, Math.min(self.viewport.height - self.viewport.y, currentY / self.height * self.viewport.height + self.viewport.y - rect.height / 2))

self.setViewportOverlayRect(rect)
self.dispatch(&#39;overlaychanged&#39;, { current: self.viewportOverlayRect })</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onOverlayMouseDown = function(e) {</p>

<pre>var self = this

captureMouse({
  mouseup: self.onOverlayMouseUp.bind(self),
  mousemove: self.onOverlayMouseMove.bind(self),
})

self.overlayDragging = true
self.overlayDragInfo = {
  mouse: { x: e.clientX, y: e.clientY },
  rect: Object.assign({}, self.viewportOverlayRect),
}
self.viewportOverlay.classList.add(&#39;moving&#39;)

self.handleOverlayDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onOverlayMouseUp = function(e) {</p>

<pre>var self = this

if (!self.overlayDragging)
  return

releaseCapture()

self.overlayDragging = false
self.viewportOverlay.classList.remove(&#39;moving&#39;)

self.handleOverlayDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.onOverlayMouseMove = function(e) {</p>

<pre>var self = this

if (!self.overlayDragging)
  return

self.handleOverlayDragGesture(e)

e.preventDefault()</pre>

<p>}</p>

<p>OverviewFlamechart.prototype.handleOverlayDragGesture = function(e) {</p>

<pre>var self = this

var deltaX = (e.clientX - self.overlayDragInfo.mouse.x) / self.width * self.viewport.width
var deltaY = (e.clientY - self.overlayDragInfo.mouse.y) / self.height * self.viewport.height

var rect = Object.assign({}, self.overlayDragInfo.rect)
rect.x += deltaX
rect.y += deltaY
rect.x = Math.max(self.viewport.x, Math.min(self.viewport.x + self.viewport.width - rect.width, rect.x))
rect.y = Math.max(self.viewport.y, Math.min(self.viewport.y + self.viewport.height - rect.height, rect.y))

self.setViewportOverlayRect(rect)
self.dispatch(&#39;overlaychanged&#39;, { current: self.viewportOverlayRect })</pre>

<p>}</p>

<p>function FlamegraphView(data, info, sortedGems) {</p>

<pre>var self = this

self.data = data
self.info = info

self.dataRange = self.computeDataRange()

self.mainChart = new MainFlamechart(document.querySelector(&#39;.flamegraph&#39;), data, self.dataRange, info)
self.overview = new OverviewFlamechart(document.querySelector(&#39;.overview-container&#39;), document.querySelector(&#39;.overview-viewport-overlay&#39;), data, self.dataRange, info)
self.infoElement = document.querySelector(&#39;.info&#39;)

self.mainChart.on(&#39;hoveredframechanged&#39;, self.onHoveredFrameChanged.bind(self))
self.mainChart.on(&#39;viewportchanged&#39;, self.onViewportChanged.bind(self))
self.overview.on(&#39;overlaychanged&#39;, self.onOverlayChanged.bind(self))

var legend = document.querySelector(&#39;.legend&#39;)
self.renderLegend(legend, sortedGems)

legend.addEventListener(&#39;mousemove&#39;, self.onLegendMouseMove.bind(self))
legend.addEventListener(&#39;mouseout&#39;, self.onLegendMouseOut.bind(self))

window.addEventListener(&#39;resize&#39;, self.updateDimensions.bind(self))

self.updateDimensions()</pre>

<p>}</p>

<p>FlamegraphView.prototype.updateDimensions = function() {</p>

<pre>var self = this

var margin = {top: 10, right: 10, bottom: 10, left: 10}
var width = window.innerWidth - 200 - margin.left - margin.right
var mainChartHeight = Math.ceil(window.innerHeight * 0.80) - margin.top - margin.bottom
var overviewHeight = Math.floor(window.innerHeight * 0.20) - 60 - margin.top - margin.bottom

self.mainChart.setDimensions(width + margin.left + margin.right, mainChartHeight + margin.top + margin.bottom)
self.overview.setDimensions(width + margin.left + margin.right, overviewHeight + margin.top + margin.bottom)
self.overview.setViewportOverlayRect(self.mainChart.viewport)</pre>

<p>}</p>

<p>FlamegraphView.prototype.computeDataRange = function() {</p>

<pre>var self = this

var range = { minX: Infinity, minY: Infinity, maxX: -Infinity, maxY: -Infinity }
self.data.forEach(function(d) {
  range.minX = Math.min(range.minX, d.x)
  range.minY = Math.min(range.minY, d.y)
  range.maxX = Math.max(range.maxX, d.x + d.width)
  range.maxY = Math.max(range.maxY, d.y + 1)
})

return range</pre>

<p>}</p>

<p>FlamegraphView.prototype.onHoveredFrameChanged = function(data) {</p>

<pre>var self = this

self.updateInfo(data.current)

if (data.previous)
  self.repaintFrames(1, self.info[data.previous.frame_id].frames)

if (data.current)
  self.repaintFrames(0.5, self.info[data.current.frame_id].frames)</pre>

<p>}</p>

<p>FlamegraphView.prototype.repaintFrames = function(opacity, frames) {</p>

<pre>var self = this

self.mainChart.paint(opacity, frames)
self.overview.paint(opacity, frames)</pre>

<p>}</p>

<p>FlamegraphView.prototype.updateInfo = function(frame) {</p>

<pre>var self = this

if (!frame) {
  self.infoElement.style.backgroundColor = &#39;&#39;
  self.infoElement.querySelector(&#39;.frame&#39;).textContent = &#39;&#39;
  self.infoElement.querySelector(&#39;.file&#39;).textContent = &#39;&#39;
  self.infoElement.querySelector(&#39;.samples&#39;).textContent = &#39;&#39;
  self.infoElement.querySelector(&#39;.exclusive&#39;).textContent = &#39;&#39;
  return
}

var i = self.info[frame.frame_id]
var shortFile = frame.file.replace(/^.+\/(gems|app|lib|config|jobs)/, &#39;$1&#39;)
var sData = self.samplePercentRaw(i.samples.length, frame.topFrame ? frame.topFrame.exclusiveCount : 0)

self.infoElement.style.backgroundColor = colorString(i.color, 1)
self.infoElement.querySelector(&#39;.frame&#39;).textContent = frame.frame
self.infoElement.querySelector(&#39;.file&#39;).textContent = shortFile
self.infoElement.querySelector(&#39;.samples&#39;).textContent = sData[0] + &#39; samples (&#39; + sData[1] + &#39;%)&#39;
if (sData[3])
  self.infoElement.querySelector(&#39;.exclusive&#39;).textContent = sData[2] + &#39; exclusive (&#39; + sData[3] + &#39;%)&#39;
else
  self.infoElement.querySelector(&#39;.exclusive&#39;).textContent = &#39;&#39;</pre>

<p>}</p>

<p>FlamegraphView.prototype.samplePercentRaw = function(samples, exclusive) {</p>

<pre>var self = this

var ret = [samples, ((samples / self.dataRange.maxX) * 100).toFixed(2)]
if (exclusive)
  ret = ret.concat([exclusive, ((exclusive / self.dataRange.maxX) * 100).toFixed(2)])
return ret</pre>

<p>}</p>

<p>FlamegraphView.prototype.onViewportChanged = function(data) {</p>

<pre>var self = this

self.overview.setViewportOverlayRect(data.current)</pre>

<p>}</p>

<p>FlamegraphView.prototype.onOverlayChanged = function(data) {</p>

<pre>var self = this

self.mainChart.setViewport(data.current)</pre>

<p>}</p>

<p>FlamegraphView.prototype.renderLegend = function(element, sortedGems) {</p>

<pre>var self = this

var fragment = document.createDocumentFragment()

sortedGems.forEach(function(gem) {
  var sData = self.samplePercentRaw(gem.samples.length)
  var node = document.createElement(&#39;div&#39;)
  node.className = &#39;legend-gem&#39;
  node.setAttribute(&#39;data-gem-name&#39;, gem.name)
  node.style.backgroundColor = colorString(gem.color, 1)

  var span = document.createElement(&#39;span&#39;)
  span.style.float = &#39;right&#39;
  span.textContent = sData[0] + &#39;x&#39;
  span.appendChild(document.createElement(&#39;br&#39;))
  span.appendChild(document.createTextNode(sData[1] + &#39;%&#39;))
  node.appendChild(span)

  var name = document.createElement(&#39;div&#39;)
  name.className = &#39;name&#39;
  name.textContent = gem.name
  name.appendChild(document.createElement(&#39;br&#39;))
  name.appendChild(document.createTextNode(&#39;\u00a0&#39;))
  node.appendChild(name)

  fragment.appendChild(node)
})

element.appendChild(fragment)</pre>

<p>}</p>

<p>FlamegraphView.prototype.onLegendMouseMove = function(e) {</p>

<pre>var self = this

var gemElement = e.target.closest(&#39;.legend-gem&#39;)
var gemName = gemElement.getAttribute(&#39;data-gem-name&#39;)

if (self.hoveredGemName === gemName)
  return

if (self.hoveredGemName) {
  self.mainChart.paint(1, null, self.hoveredGemName)
  self.overview.paint(1, null, self.hoveredGemName)
}

self.hoveredGemName = gemName

self.mainChart.paint(0.5, null, self.hoveredGemName)
self.overview.paint(0.5, null, self.hoveredGemName)</pre>

<p>}</p>

<p>FlamegraphView.prototype.onLegendMouseOut = function() {</p>

<pre>var self = this

if (!self.hoveredGemName)
  return

self.mainChart.paint(1, null, self.hoveredGemName)
self.overview.paint(1, null, self.hoveredGemName)
self.hoveredGemName = null</pre>

<p>}</p>

<p>var capturingListeners = null function captureMouse(listeners) {</p>

<pre>if (capturingListeners)
  releaseCapture()

for (var name in listeners)
  document.addEventListener(name, listeners[name], true)
capturingListeners = listeners</pre>

<p>}</p>

<p>function releaseCapture() {</p>

<pre>if (!capturingListeners)
  return

for (var name in capturingListeners)
  document.removeEventListener(name, capturingListeners[name], true)
capturingListeners = null</pre>

<p>}</p>

<p>function guessGem(frame) {</p>

<pre>var split = frame.split(&#39;/gems/&#39;)
if (split.length === 1) {
  split = frame.split(&#39;/app/&#39;)
  if (split.length === 1) {
    split = frame.split(&#39;/lib/&#39;)
  } else {
    return split[split.length - 1].split(&#39;/&#39;)[0]
  }

  split = split[Math.max(split.length - 2, 0)].split(&#39;/&#39;)
  return split[split.length - 1].split(&#39;:&#39;)[0]
}
else
{
  return split[split.length - 1].split(&#39;/&#39;)[0].split(&#39;-&#39;, 2)[0]
}</pre>

<p>}</p>

<p>function color() {</p>

<pre class="ruby"><span class="ruby-identifier">var</span> <span class="ruby-identifier">r</span> = <span class="ruby-identifier">parseInt</span>(<span class="ruby-value">205</span> <span class="ruby-operator">+</span> <span class="ruby-constant">Math</span>.<span class="ruby-identifier">random</span>() <span class="ruby-operator">*</span> <span class="ruby-value">50</span>)
<span class="ruby-identifier">var</span> <span class="ruby-identifier">g</span> = <span class="ruby-identifier">parseInt</span>(<span class="ruby-constant">Math</span>.<span class="ruby-identifier">random</span>() <span class="ruby-operator">*</span> <span class="ruby-value">230</span>)
<span class="ruby-identifier">var</span> <span class="ruby-identifier">b</span> = <span class="ruby-identifier">parseInt</span>(<span class="ruby-constant">Math</span>.<span class="ruby-identifier">random</span>() <span class="ruby-operator">*</span> <span class="ruby-value">55</span>)
<span class="ruby-keyword">return</span> [<span class="ruby-identifier">r</span>, <span class="ruby-identifier">g</span>, <span class="ruby-identifier">b</span>]
</pre>

<p>}</p>

<p>// <a href="http://stackoverflow.com/a/7419630">stackoverflow.com/a/7419630</a> function rainbow(numOfSteps, step) {</p>

<pre>  // This function generates vibrant, &quot;evenly spaced&quot; colours (i.e. no clustering). This is ideal for creating easily distiguishable vibrant markers in Google Maps and other apps.
  // Adam Cole, 2011-Sept-14
  // HSV to RBG adapted from: http://mjijackson.com/2008/02/rgb-to-hsl-and-rgb-to-hsv-color-model-conversion-algorithms-in-javascript
var r, g, b
var h = step / numOfSteps
var i = ~~(h * 6)
var f = h * 6 - i
var q = 1 - f
switch (i % 6) {
  case 0: r = 1, g = f, b = 0; break
  case 1: r = q, g = 1, b = 0; break
  case 2: r = 0, g = 1, b = f; break
  case 3: r = 0, g = q, b = 1; break
  case 4: r = f, g = 0, b = 1; break
  case 5: r = 1, g = 0, b = q; break
}
return [Math.floor(r * 255), Math.floor(g * 255), Math.floor(b * 255)]</pre>

<p>}</p>

<p>function colorString(color, opacity) {</p>

<pre>if (typeof opacity === &#39;undefined&#39;)
  opacity = 1
return &#39;rgba(&#39; + color.join(&#39;,&#39;) + &#39;,&#39; + opacity + &#39;)&#39;</pre>

<p>}</p>

<p>// <a href="http://stackoverflow.com/questions/1960473/unique-values-in-an-array">stackoverflow.com/questions/1960473/unique-values-in-an-array</a> function getUnique(orig) {</p>

<pre>var o = {}
for (var i = 0; i &lt; orig.length; i++) o[orig[i]] = 1
return Object.keys(o)</pre>

<p>}</p>

<p>function centerTruncate(text, maxLength) {</p>

<pre>var charactersToKeep = maxLength - 1
if (charactersToKeep &lt;= 0)
  return &#39;&#39;
if (text.length &lt;= charactersToKeep)
  return text

var prefixLength = Math.ceil(charactersToKeep / 2)
var suffixLength = charactersToKeep - prefixLength
var prefix = text.substr(0, prefixLength)
var suffix = suffixLength &gt; 0 ? text.substr(-suffixLength) : &#39;&#39;

return [prefix, &#39;\u2026&#39;, suffix].join(&#39;&#39;)</pre>

<p>}</p>

<p>function flamegraph(data) {</p>

<pre>var info = {}
data.forEach(function(d) {
  var i = info[d.frame_id]
  if (!i)
    info[d.frame_id] = i = {frames: [], samples: [], color: color()}
  i.frames.push(d)
  for (var j = 0; j &lt; d.width; j++) {
    i.samples.push(d.x + j)
  }
})

// Samples may overlap on the same line
for (var r in info) {
  if (info[r].samples) {
    info[r].samples = getUnique(info[r].samples)
  }
}

// assign some colors, analyze samples per gem
var gemStats = {}
var topFrames = {}
var lastFrame = {frame: &#39;d52e04d-df28-41ed-a215-b6ec840a8ea5&#39;, x: -1}

data.forEach(function(d) {
  var gem = guessGem(d.file)
  var stat = gemStats[gem]
  d.gemName = gem

  if (!stat) {
    gemStats[gem] = stat = {name: gem, samples: [], frames: []}
  }

  stat.frames.push(d.frame_id)
  for (var j = 0; j &lt; d.width; j++) {
    stat.samples.push(d.x + j)
  }
  // This assumes the traversal is in order
  if (lastFrame.x !== d.x) {
    var topFrame = topFrames[lastFrame.frame_id]
    if (!topFrame) {
      topFrames[lastFrame.frame_id] = topFrame = {exclusiveCount: 0}
    }
    topFrame.exclusiveCount += 1
    lastFrame.topFrame = topFrame
  }
  lastFrame = d
})

var topFrame = topFrames[lastFrame.frame_id]
if (!topFrame) {
  topFrames[lastFrame.frame_id] = topFrame = {exclusiveCount: 0}
}
topFrame.exclusiveCount += 1
lastFrame.topFrame = topFrame

var totalGems = 0
for (var k in gemStats) {
  totalGems++
  gemStats[k].samples = getUnique(gemStats[k].samples)
}

var gemsSorted = Object.keys(gemStats).map(function(k) { return gemStats[k] })
gemsSorted.sort(function(a, b) { return b.samples.length - a.samples.length })

var currentIndex = 0
gemsSorted.forEach(function(stat) {
  stat.color = rainbow(totalGems, currentIndex)
  currentIndex += 1

  for (var x = 0; x &lt; stat.frames.length; x++) {
    info[stat.frames[x]].color = stat.color
  }
})

new FlamegraphView(data, info, gemsSorted)</pre>

<p>}</p>

</main>

