<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>README - RDoc Documentation</title>

  <meta name="keywords" content="ruby,documentation,README">
  <meta name="description" content="README: Stackprof A sampling call-stack profiler for Ruby. Requirements * Ruby 2.">

<script type="text/javascript">
  var rdoc_rel_prefix = "../../../../../../";
  var index_rel_prefix = "../../../../../../";
</script>

<script src="../../../../../../js/navigation.js" defer></script>
<script src="../../../../../../js/search.js" defer></script>
<script src="../../../../../../js/search_index.js" defer></script>
<script src="../../../../../../js/searcher.js" defer></script>
<script src="../../../../../../js/darkfish.js" defer></script>

<link href="../../../../../../css/fonts.css" rel="stylesheet">
<link href="../../../../../../css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../../../../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../../../../../table_of_contents.html#pages">Pages</a>
    <a href="../../../../../../table_of_contents.html#classes">Classes</a>
    <a href="../../../../../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>



  <ul class="link-list" role="directory">
              <li>
            <details open>
              <summary>      <a href="#label-Stackprof">Stackprof</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Requirements">Requirements</a>
          <li>
            <details open>
              <summary>      <a href="#label-Getting+Started">Getting Started</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Install">Install</a>
          <li>      <a href="#label-Run">Run</a>

              </ul>
            </details>
          </li>
          <li>      <a href="#label-Sampling">Sampling</a>
          <li>      <a href="#label-Aggregation">Aggregation</a>
          <li>
            <details open>
              <summary>      <a href="#label-Reporting">Reporting</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-StackProf-3A-3AReport.new-28data-29.print_text"><code>StackProf::Report.new(data).print_text</code></a>
          <li>      <a href="#label-StackProf-3A-3AReport.new-28data-29.print_graphviz"><code>StackProf::Report.new(data).print_graphviz</code></a>
          <li>      <a href="#label-StackProf-3A-3AReport.new-28data-29.print_method-28-2Fpow-7Cnewobj-7Cmath-2F-29"><code>StackProf::Report.new(data).print_method(/pow|newobj|math/)</code></a>

              </ul>
            </details>
          </li>
          <li>      <a href="#label-Usage">Usage</a>
          <li>      <a href="#label-Advanced+usage">Advanced usage</a>
          <li>      <a href="#label-All+options">All options</a>
          <li>      <a href="#label-Todo">Todo</a>

              </ul>
            </details>
          </li>

  </ul>
</div>

  
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><a href="../../../../../../CHANGELOG_md.html">CHANGELOG</a>
    <li><a href="../../../../../../CONTRIBUTION_md.html">CONTRIBUTION</a>
    <li><a href="../../../../../../Dockerfile.html">Dockerfile</a>
    <li><a href="../../../../../../Gemfile.html">Gemfile</a>
    <li><a href="../../../../../../Gemfile_lock.html">Gemfile.lock</a>
    <li><a href="../../../../../../LICENSE.html">LICENSE</a>
    <li><a href="../../../../../../README_md.html">README</a>
    <li><a href="../../../../../../Rakefile.html">Rakefile</a>
    <li><a href="../../../../../../bin/setup.html">setup</a>
    <li><a href="../../../../../../getduckdb_sh.html">getduckdb.sh</a>
    <li><details open><summary>vendor</summary>
    <ul class="link-list">
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/bin/stackprof-flamegraph_pl.html">stackprof-flamegraph.pl</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/bin/stackprof-gprof2dot_py.html">stackprof-gprof2dot.py</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/bigdecimal-3_1_8/mkmf_log.html">mkmf.log</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/racc-1_8_1/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/racc-1_8_1/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/gem_build_complete.html">gem.build_complete</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/gem_make_out.html">gem_make.out</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/extensions/x86_64-linux/3_4_0/stackprof-0_2_26/mkmf_log.html">mkmf.log</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/History_md.html">History</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/benchmark-ips-2_14_0/README_md.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/bigdecimal-3_1_8/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/bigdecimal-3_1_8/ext/bigdecimal/Makefile.html">Makefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/History_rdoc.html">History</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/Manifest_txt.html">Manifest</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/README_rdoc.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/minitest-5_25_2/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/LICENSE-DEPENDENCIES_md.html">LICENSE-DEPENDENCIES</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/LICENSE_md.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/README_md.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/ext/nokogiri/depend.html">depend</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/CHANGES_md.html">CHANGES</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/Makefile.html">Makefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/gumbo-parser/THANKS.html">THANKS</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/nokogiri-1_18_0-x86_64-linux-gnu/lib/nokogiri/css/tokenizer_rex.html">tokenizer.rex</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/BSDL.html">BSDL</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/COPYING.html">COPYING</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/ChangeLog.html">ChangeLog</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/README_ja_rdoc.html">README.ja</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/README_rdoc.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/TODO.html">TODO</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/en/grammar_en_rdoc.html">grammar.en</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/en/grammar2_en_rdoc.html">grammar2.en</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/command_ja_html.html">command.ja.html</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/debug_ja_rdoc.html">debug.ja</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/grammar_ja_rdoc.html">grammar.ja</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/index_ja_html.html">index.ja.html</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/parser_ja_rdoc.html">parser.ja</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/doc/ja/usage_ja_html.html">usage.ja.html</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/racc-1_8_1/ext/racc/cparse/Makefile.html">Makefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/History_rdoc.html">History</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/MIT-LICENSE.html">MIT-LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/README_rdoc.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/command_line_usage_rdoc.html">command_line_usage</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/example/Rakefile1.html">Rakefile1</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/example/Rakefile2.html">Rakefile2</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/glossary_rdoc.html">glossary</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/proto_rake_rdoc.html">proto_rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rake_1.html">rake.1</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rakefile_rdoc.html">rakefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-13_2_1/doc/rational_rdoc.html">rational</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/History_md.html">History</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/LICENSE_txt.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/README_md.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/compile_feature.html">compile.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-compile_feature.html">cross-compile.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-package-multi_feature.html">cross-package-multi.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/cross-package_feature.html">cross-package.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-compile_feature.html">java-compile.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-no-native-compile_feature.html">java-no-native-compile.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/java-package_feature.html">java-package.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/features/package_feature.html">package.feature</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/bin/cross-ruby_rake.html">cross-ruby.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/bootstrap_rake.html">bootstrap.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/common_rake.html">common.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/cucumber_rake.html">cucumber.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/gem_rake.html">gem.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/rake-compiler-1_2_8/tasks/rspec_rake.html">rspec.rake</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Gemfile_lock.html">Gemfile.lock</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/LICENSE_txt.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/README_md.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/ruby_memcheck-3_0_0/suppressions/ruby_supp.html">ruby.supp</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/CHANGELOG_md.html">CHANGELOG</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/Gemfile.html">Gemfile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/LICENSE.html">LICENSE</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/README_md.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/Rakefile.html">Rakefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/bin/stackprof-flamegraph_pl.html">stackprof-flamegraph.pl</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/bin/stackprof-gprof2dot_py.html">stackprof-gprof2dot.py</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/ext/stackprof/Makefile.html">Makefile</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/lib/stackprof/flamegraph/flamegraph_js.html">flamegraph.js</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/lib/stackprof/flamegraph/viewer_html.html">viewer.html</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/FlameGraph/README.html">README</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/FlameGraph/flamegraph_pl.html">flamegraph.pl</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/gprof2dot/gprof2dot_py.html">gprof2dot.py</a>
      <li><a href="../../../../../../vendor/bundle/ruby/3_4_0/gems/stackprof-0_2_26/vendor/gprof2dot/hotshotmain_py.html">hotshotmain.py</a>
    </ul></details>
  </ul>
</div>


  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.10.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

</nav>

<main role="main" aria-label="Page vendor/bundle/ruby/3.4.0/gems/stackprof-0.2.26/README.md">

<h1 id="label-Stackprof">Stackprof<span><a href="#label-Stackprof">&para;</a> <a href="#top">&uarr;</a></span></h1>

<p><a href="../../../../../../A.html"><code>A</code></a> sampling call-stack profiler for Ruby.</p>

<p>Inspired heavily by <a href="https://code.google.com/p/gperftools/">gperftools</a>, and written as a replacement for <a href="https://github.com/tmm1/perftools.rb">perftools.rb</a>.</p>

<h2 id="label-Requirements">Requirements<span><a href="#label-Requirements">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>Ruby 2.2+</p>
</li><li>
<p>Linux-based OS</p>
</li></ul>

<h2 id="label-Getting+Started">Getting Started<span><a href="#label-Getting+Started">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Install">Install<span><a href="#label-Install">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>In your <a href="../../../../../../Gemfile.html">Gemfile</a> add:</p>

<pre class="ruby"><span class="ruby-identifier">gem</span> <span class="ruby-string">&#39;stackprof&#39;</span>
</pre>

<p>Then run <code>$ bundle install</code>. Alternatively you can run <code>$ gem install stackprof</code>.</p>

<h3 id="label-Run">Run<span><a href="#label-Run">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>in ruby:</p>

<pre class="ruby"><span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">run</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:cpu</span>, <span class="ruby-value">out:</span> <span class="ruby-string">&#39;tmp/stackprof-cpu-myapp.dump&#39;</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-comment">#...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>via rack:</p>

<pre class="ruby"><span class="ruby-identifier">use</span> <span class="ruby-constant">StackProf</span><span class="ruby-operator">::</span><span class="ruby-constant">Middleware</span>, <span class="ruby-value">enabled:</span> <span class="ruby-keyword">true</span>,
                           <span class="ruby-value">mode:</span> <span class="ruby-value">:cpu</span>,
                           <span class="ruby-value">interval:</span> <span class="ruby-value">1000</span>,
                           <span class="ruby-value">save_every:</span> <span class="ruby-value">5</span>
</pre>

<p>reporting:</p>

<pre>$ stackprof tmp/stackprof-cpu-*.dump --text --limit 1
  ==================================
    Mode: cpu(1000)
    Samples: 60395 (1.09% miss rate)
    GC: 2851 (4.72%)
  ==================================
       TOTAL    (pct)     SAMPLES    (pct)     FRAME
        1660   (2.7%)        1595   (2.6%)     String#blank?

$ stackprof tmp/stackprof-cpu-*.dump --method &#39;String#blank?&#39;
  String#blank? (gems/activesupport-2.3.14.github30/lib/active_support/core_ext/object/blank.rb:80)
    samples:  1595 self (2.6%)  /   1660 total (2.7%)
    callers:
       373  (   41.0%)  ApplicationHelper#current_user
       192  (   21.1%)  ApplicationHelper#current_repository
    callers:
       803  (   48.4%)  Object#present?
    code:
                                    |    80  |   def blank?
   1225    (2.0%) /  1225   (2.0%)  |    81  |     self !~ /[^[:space:]]/
                                    |    82  |   end

$ stackprof tmp/stackprof-cpu-*.dump --method &#39;Object#present?&#39;
  Object#present? (gems/activesupport-2.3.14.github30/lib/active_support/core_ext/object/blank.rb:20)
    samples:    59 self (0.1%)  /    910 total (1.5%)
    callees (851 total):
       803  (   94.4%)  String#blank?
        32  (    3.8%)  Object#blank?
        16  (    1.9%)  NilClass#blank?
    code:
                                    |    20  |   def present?
    910    (1.5%) /    59   (0.1%)  |    21  |     !blank?
                                    |    22  |   end</pre>

<p>For an experimental version of WebUI reporting of stackprof, see <a href="https://github.com/alisnic/stackprof-webnav">stackprof-webnav</a></p>

<p>To generate flamegraphs with Stackprof, additional data must be collected using the <code>raw: true</code> flag. Once you’ve collected results with this flag enabled, generate a flamegraph with:</p>

<pre>$ stackprof --flamegraph tmp/stackprof-cpu-myapp.dump &gt; tmp/flamegraph</pre>

<p>After the flamegraph has been generated, you can generate a viewer command with:</p>

<pre>$ stackprof --flamegraph-viewer=tmp/flamegraph</pre>

<p>The <code>--flamegraph-viewer</code> command will output the exact shell command you need to run in order to open the <code>tmp/flamegraph</code> you generated with the built-in stackprof flamegraph viewer:</p>

<p><img src="http://i.imgur.com/EwndrgD.png"></p>

<p>Alternatively, you can generate a flamegraph that uses <a href="https://github.com/spiermar/d3-flame-graph">d3-flame-graph</a>:</p>

<pre>$ stackprof --d3-flamegraph tmp/stackprof-cpu-myapp.dump &gt; flamegraph.html</pre>

<p>And just open the result by your browser.</p>

<h2 id="label-Sampling">Sampling<span><a href="#label-Sampling">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Four sampling modes are supported:</p>
<ul><li>
<p><code>:wall</code> (using <code>ITIMER_REAL</code> and <code>SIGALRM</code>) [default mode]</p>
</li><li>
<p><code>:cpu</code> (using <code>ITIMER_PROF</code> and <code>SIGPROF</code>)</p>
</li><li>
<p><code>:object</code> (using <code>RUBY_INTERNAL_EVENT_NEWOBJ</code>)</p>
</li><li>
<p><code>:custom</code> (user-defined via <a href="../../../../../../StackProf.html#method-c-sample"><code>StackProf.sample</code></a>)</p>
</li></ul>

<p>Samplers have a tuneable interval which can be used to reduce overhead or increase granularity:</p>
<ul><li>
<p>Wall time: sample every <em>interval</em> microseconds of wallclock time (default: 1000)</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">run</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:wall</span>, <span class="ruby-value">out:</span> <span class="ruby-string">&#39;tmp/stackprof.dump&#39;</span>, <span class="ruby-value">interval:</span> <span class="ruby-value">1000</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-comment">#...</span>
<span class="ruby-keyword">end</span>
</pre>
<ul><li>
<p>CPU time: sample every <em>interval</em> microseconds of CPU activity (default: 1000 = 1 millisecond)</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">run</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:cpu</span>, <span class="ruby-value">out:</span> <span class="ruby-string">&#39;tmp/stackprof.dump&#39;</span>, <span class="ruby-value">interval:</span> <span class="ruby-value">1000</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-comment">#...</span>
<span class="ruby-keyword">end</span>
</pre>
<ul><li>
<p><a href="../../../../../../Object.html"><code>Object</code></a> allocation: sample every <em>interval</em> allocations (default: 1)</p>
</li></ul>

<pre class="ruby"><span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">run</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:object</span>, <span class="ruby-value">out:</span> <span class="ruby-string">&#39;tmp/stackprof.dump&#39;</span>, <span class="ruby-value">interval:</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-comment">#...</span>
<span class="ruby-keyword">end</span>
</pre>

<p>By default, samples taken during garbage collection will show as garbage collection frames including both mark and sweep phases. For longer traces, these can leave gaps in a flamegraph that are hard to follow. They can be disabled by setting the <code>ignore_gc</code> option to true. Garbage collection time will still be present in the profile but not explicitly marked with its own frame.</p>

<p>Samples are taken using a combination of three new C-APIs in ruby 2.1:</p>
<ul><li>
<p>Signal handlers enqueue a sampling job using <code>rb_postponed_job_register_one</code>. this ensures callstack samples can be taken safely, in case the VM is garbage collecting or in some other inconsistent state during the interruption.</p>
</li><li>
<p>Stack frames are collected via <code>rb_profile_frames</code>, which provides low-overhead C-API access to the VM's call stack. No object allocations occur in this path, allowing stackprof to collect callstacks in allocation mode.</p>
</li><li>
<p>In allocation mode, samples are taken via <code>rb_tracepoint_new(RUBY_INTERNAL_EVENT_NEWOBJ)</code>, which provides a notification every time the VM allocates a new object.</p>
</li></ul>

<h2 id="label-Aggregation">Aggregation<span><a href="#label-Aggregation">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Each sample consists of N stack frames, where a frame looks something like <code>MyClass#method</code> or <code>block in MySingleton.method</code>. For each of these frames in the sample, the profiler collects a few pieces of metadata:</p>
<ul><li>
<p><code>samples</code>: Number of samples where this was the topmost frame</p>
</li><li>
<p><code>total_samples</code>: Samples where this frame was in the stack</p>
</li><li>
<p><code>lines</code>: Samples per line number in this frame</p>
</li><li>
<p><code>edges</code>: Samples per callee frame (methods invoked by this frame)</p>
</li></ul>

<p>The aggregation algorithm is roughly equivalent to the following pseudo code:</p>

<pre class="ruby"><span class="ruby-identifier">trap</span>(<span class="ruby-string">&#39;PROF&#39;</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-identifier">top</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">rest</span> = <span class="ruby-identifier">caller</span>

  <span class="ruby-identifier">top</span>.<span class="ruby-identifier">samples</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">top</span>.<span class="ruby-identifier">lines</span>[<span class="ruby-identifier">top</span>.<span class="ruby-identifier">lineno</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-identifier">top</span>.<span class="ruby-identifier">total_samples</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

  <span class="ruby-identifier">prev</span> = <span class="ruby-identifier">top</span>
  <span class="ruby-identifier">rest</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">frame</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">frame</span>.<span class="ruby-identifier">edges</span>[<span class="ruby-identifier">prev</span>] <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">frame</span>.<span class="ruby-identifier">total_samples</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">prev</span> = <span class="ruby-identifier">frame</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This technique builds up an incremental call graph from the samples. On any given frame, the sum of the outbound edge weights is equal to total samples collected on that frame (<code>frame.total_samples == frame.edges.values.sum</code>).</p>

<h2 id="label-Reporting">Reporting<span><a href="#label-Reporting">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Multiple reporting modes are supported: - Text - Dotgraph - Source annotation</p>

<h3 id="label-StackProf-3A-3AReport.new-28data-29.print_text"><a href="../../../../../../StackProf/Report.html#method-c-new"><code>StackProf::Report.new(data).print_text</code></a><span><a href="#label-StackProf-3A-3AReport.new-28data-29.print_text">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre>TOTAL    (pct)     SAMPLES    (pct)     FRAME
        91  (48.4%)          91  (48.4%)     A#pow
        58  (30.9%)          58  (30.9%)     A.newobj
        34  (18.1%)          34  (18.1%)     block in A#math
       188 (100.0%)           3   (1.6%)     block (2 levels) in &lt;main&gt;
       185  (98.4%)           1   (0.5%)     A#initialize
        35  (18.6%)           1   (0.5%)     A#math
       188 (100.0%)           0   (0.0%)     &lt;main&gt;
       188 (100.0%)           0   (0.0%)     block in &lt;main&gt;
       188 (100.0%)           0   (0.0%)     &lt;main&gt;</pre>

<h3 id="label-StackProf-3A-3AReport.new-28data-29.print_graphviz"><a href="../../../../../../StackProf/Report.html#method-c-new"><code>StackProf::Report.new(data).print_graphviz</code></a><span><a href="#label-StackProf-3A-3AReport.new-28data-29.print_graphviz">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre>digraph profile {
  70346498324780 [size=23.5531914893617] [fontsize=23.5531914893617] [shape=box] [label=&quot;A#pow\n91 (48.4%)\r&quot;];
  70346498324680 [size=18.638297872340424] [fontsize=18.638297872340424] [shape=box] [label=&quot;A.newobj\n58 (30.9%)\r&quot;];
  70346498324480 [size=15.063829787234042] [fontsize=15.063829787234042] [shape=box] [label=&quot;block in A#math\n34 (18.1%)\r&quot;];
  70346498324220 [size=10.446808510638299] [fontsize=10.446808510638299] [shape=box] [label=&quot;block (2 levels) in &lt;main&gt;\n3 (1.6%)\rof 188 (100.0%)\r&quot;];
  70346498324220 -&gt; 70346498324900 [label=&quot;185&quot;];
  70346498324900 [size=10.148936170212766] [fontsize=10.148936170212766] [shape=box] [label=&quot;A#initialize\n1 (0.5%)\rof 185 (98.4%)\r&quot;];
  70346498324900 -&gt; 70346498324780 [label=&quot;91&quot;];
  70346498324900 -&gt; 70346498324680 [label=&quot;58&quot;];
  70346498324900 -&gt; 70346498324580 [label=&quot;35&quot;];
  70346498324580 [size=10.148936170212766] [fontsize=10.148936170212766] [shape=box] [label=&quot;A#math\n1 (0.5%)\rof 35 (18.6%)\r&quot;];
  70346498324580 -&gt; 70346498324480 [label=&quot;34&quot;];
  70346497983360 [size=10.0] [fontsize=10.0] [shape=box] [label=&quot;&lt;main&gt;\n0 (0.0%)\rof 188 (100.0%)\r&quot;];
  70346497983360 -&gt; 70346498325080 [label=&quot;188&quot;];
  70346498324300 [size=10.0] [fontsize=10.0] [shape=box] [label=&quot;block in &lt;main&gt;\n0 (0.0%)\rof 188 (100.0%)\r&quot;];
  70346498324300 -&gt; 70346498324220 [label=&quot;188&quot;];
  70346498325080 [size=10.0] [fontsize=10.0] [shape=box] [label=&quot;&lt;main&gt;\n0 (0.0%)\rof 188 (100.0%)\r&quot;];
  70346498325080 -&gt; 70346498324300 [label=&quot;188&quot;];
}</pre>

<h3 id="label-StackProf-3A-3AReport.new-28data-29.print_method-28-2Fpow-7Cnewobj-7Cmath-2F-29"><a href="../../../../../../StackProf/Report.html#method-c-new"><code>StackProf::Report.new(data).print_method(/pow|newobj|math/)</code></a><span><a href="#label-StackProf-3A-3AReport.new-28data-29.print_method-28-2Fpow-7Cnewobj-7Cmath-2F-29">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre>A#pow (/Users/tmm1/code/stackprof/sample.rb:11)
                         |    11  |   def pow
   91  (48.4% / 100.0%)  |    12  |     2 ** 100
                         |    13  |   end
A.newobj (/Users/tmm1/code/stackprof/sample.rb:15)
                         |    15  |   def self.newobj
   33  (17.6% /  56.9%)  |    16  |     Object.new
   25  (13.3% /  43.1%)  |    17  |     Object.new
                         |    18  |   end
A#math (/Users/tmm1/code/stackprof/sample.rb:20)
                         |    20  |   def math
    1   (0.5% / 100.0%)  |    21  |     2.times do
                         |    22  |       2 + 3 * 4 ^ 5 / 6
block in A#math (/Users/tmm1/code/stackprof/sample.rb:21)
                         |    21  |     2.times do
   34  (18.1% / 100.0%)  |    22  |       2 + 3 * 4 ^ 5 / 6
                         |    23  |     end</pre>

<h2 id="label-Usage">Usage<span><a href="#label-Usage">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The profiler is compiled as a C-extension and exposes a simple api: <a href="../../../../../../StackProf.html#method-c-run"><code>StackProf.run(mode: [:cpu|:wall|:object])</code></a>. The <code>run</code> method takes a block of code and returns a profile as a simple hash.</p>

<pre class="ruby"><span class="ruby-comment"># sample after every 1ms of cpu activity</span>
<span class="ruby-identifier">profile</span> = <span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">run</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:cpu</span>, <span class="ruby-value">interval:</span> <span class="ruby-value">1000</span>) <span class="ruby-keyword">do</span>
  <span class="ruby-constant">MyCode</span>.<span class="ruby-identifier">execute</span>
<span class="ruby-keyword">end</span>
</pre>

<p>This profile data structure is part of the public API, and is intended to be saved (as json/marshal for example) for later processing. The reports above can be generated by passing this structure into <a href="../../../../../../StackProf/Report.html#method-c-new"><code>StackProf::Report.new</code></a>.</p>

<p>The format itself is very simple. It contains a header and a list of frames. Each frame has a unique ID and identifying information such as its name, file, and line. The frame also contains sampling data, including per-line samples, and a list of relationships to other frames represented as weighted edges.</p>

<pre class="ruby">{<span class="ruby-value">:version</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1.0</span>,
 <span class="ruby-value">:mode</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">:cpu</span>,
 <span class="ruby-value">:inteval</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1000</span>,
 <span class="ruby-value">:samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">188</span>,
 <span class="ruby-value">:missed_samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">0</span>,
 <span class="ruby-value">:frames</span><span class="ruby-operator">=&gt;</span>
  {<span class="ruby-value">70346498324780</span><span class="ruby-operator">=&gt;</span>
    {<span class="ruby-value">:name</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;A#pow&quot;</span>,
     <span class="ruby-value">:file</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;/Users/tmm1/code/stackprof/sample.rb&quot;</span>,
     <span class="ruby-value">:line</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">11</span>,
     <span class="ruby-value">:total_samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">91</span>,
     <span class="ruby-value">:samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">91</span>,
     <span class="ruby-value">:lines</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-value">12</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">91</span>}},
   <span class="ruby-value">70346498324900</span><span class="ruby-operator">=&gt;</span>
    {<span class="ruby-value">:name</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;A#initialize&quot;</span>,
     <span class="ruby-value">:file</span><span class="ruby-operator">=&gt;</span><span class="ruby-string">&quot;/Users/tmm1/code/stackprof/sample.rb&quot;</span>,
     <span class="ruby-value">:line</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">5</span>,
     <span class="ruby-value">:total_samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">185</span>,
     <span class="ruby-value">:samples</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>,
     <span class="ruby-value">:edges</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-value">70346498324780</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">91</span>, <span class="ruby-value">70346498324680</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">58</span>, <span class="ruby-value">70346498324580</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">35</span>},
     <span class="ruby-value">:lines</span><span class="ruby-operator">=&gt;</span>{<span class="ruby-value">8</span><span class="ruby-operator">=&gt;</span><span class="ruby-value">1</span>}},
</pre>

<p>Above, <a href="../../../../../../A.html#method-i-pow"><code>A#pow</code></a> was involved in 91 samples, and in all cases it was at the top of the stack on line 12.</p>

<p><code>A#initialize</code> was in 185 samples, but it was at the top of the stack in only 1 sample. The rest of the samples are divided up between its callee edges. All 91 calls to <a href="../../../../../../A.html#method-i-pow"><code>A#pow</code></a> came from <code>A#initialize</code>, as seen by the edge numbered <code>70346498324780</code>.</p>

<h2 id="label-Advanced+usage">Advanced usage<span><a href="#label-Advanced+usage">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The profiler can be started and stopped manually. Results are accumulated until retrieval, across multiple <code>start</code>/<code>stop</code> invocations.</p>

<pre class="ruby"><span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">running?</span> <span class="ruby-comment"># =&gt; false</span>
<span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">start</span>(<span class="ruby-value">mode:</span> <span class="ruby-value">:cpu</span>)
<span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">running?</span> <span class="ruby-comment"># =&gt; true</span>
<span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">stop</span>
<span class="ruby-constant">StackProf</span>.<span class="ruby-identifier">results</span>(<span class="ruby-string">&#39;/tmp/some.file&#39;</span>)
</pre>

<h2 id="label-All+options">All options<span><a href="#label-All+options">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p><a href="../../../../../../StackProf.html#method-c-run"><code>StackProf.run</code></a> accepts an options hash. Currently, the following options are recognized:</p>

<p>Option | Meaning ——- | ——— <code>mode</code> | Mode of sampling: <code>:cpu</code>, <code>:wall</code>, <code>:object</code>, or <code>:custom</code> <a href="#sampling">c.f.</a> <code>out</code> | The target file, which will be overwritten <code>interval</code> | Mode-relative sample rate <a href="#sampling">c.f.</a> <code>ignore_gc</code> | Ignore garbage collection frames <code>aggregate</code> | Defaults: <code>true</code> - if <code>false</code> disables <a href="#aggregation">aggregation</a> <code>raw</code> | Defaults <code>false</code> - if <code>true</code> collects the extra data required by the <code>--flamegraph</code> and <code>--stackcollapse</code> report types <code>metadata</code> | Defaults to <code>{}</code>. Must be a <code>Hash</code>. metadata associated with this profile <code>save_every</code>| (Rack middleware only) write the target file after this many requests</p>

<h2 id="label-Todo">Todo<span><a href="#label-Todo">&para;</a> <a href="#top">&uarr;</a></span></h2>
<ul><li>
<p>file/iseq blacklist</p>
</li><li>
<p>restore signal handlers on stop</p>
</li></ul>

</main>

